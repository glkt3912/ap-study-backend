#!/bin/bash

# =================================================================
# Claudeä¸»å°ŽPRç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# =================================================================

set -e

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ãƒ­ã‚°é–¢æ•°
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# å¼•æ•°å‡¦ç†
PR_THEME="${1:-"æ©Ÿèƒ½æ”¹å–„"}"
OUTPUT_MODE="${2:-"interactive"}"  # interactive | auto | dry-run

log_info "ðŸ¤– Claudeä¸»å°ŽPRç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
log_info "ãƒ†ãƒ¼ãƒž: $PR_THEME"
log_info "ãƒ¢ãƒ¼ãƒ‰: $OUTPUT_MODE"

cd "$PROJECT_ROOT"

# 1. ãƒ‡ãƒ¼ã‚¿åŽé›†å®Ÿè¡Œ
log_info "ðŸ“Š PRãƒ‡ãƒ¼ã‚¿åŽé›†ä¸­..."
if ! ./scripts/collect-pr-data.sh /tmp/pr-analysis.json; then
    log_error "ãƒ‡ãƒ¼ã‚¿åŽé›†ã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi

log_success "ãƒ‡ãƒ¼ã‚¿åŽé›†å®Œäº†"

# 2. JSON ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
if [ ! -f "/tmp/pr-analysis.json" ]; then
    log_error "PRåˆ†æžãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

# 3. Claude Codeå‘ã‘ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ç”Ÿæˆ
log_info "ðŸ§  Claude Codeè§£æžã‚¬ã‚¤ãƒ€ãƒ³ã‚¹æº–å‚™ä¸­..."

# Claudeå‘ã‘ã®è§£æžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
cat > /tmp/claude-pr-prompt.md << EOF
# Claude Code PRç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ

## ðŸŽ¯ ã‚¿ã‚¹ã‚¯æ¦‚è¦
ä»¥ä¸‹ã®JSONåˆ†æžãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–‡è„ˆã‚’ç†è§£ã—ã¦é«˜å“è³ªãªPRæ–‡æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## ðŸ“‹ è¦æ±‚ä»•æ§˜

### PRæ–‡æ›¸ç”Ÿæˆå†…å®¹
1. **PRã‚¿ã‚¤ãƒˆãƒ«** (æ—¥æœ¬èªž + è‹±èªžConventional Commits)
2. **PRèª¬æ˜Žæ–‡** (markdownå½¢å¼ã€æ—¥æœ¬èªžãƒ¡ã‚¤ãƒ³)
3. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰** (ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å‘ã‘ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ)
4. **å“è³ªãƒã‚§ãƒƒã‚¯çµæžœçµ±åˆ** (ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»Lintçµæžœã®è§£é‡ˆ)

### å“è³ªåŸºæº–
- âœ… **è‡ªç„¶ãªæ—¥æœ¬èªž**: æ©Ÿæ¢°çš„ã§ãªã„ã€èª­ã¿ã‚„ã™ã„è¡¨ç¾
- âœ… **æŠ€è¡“çš„æ­£ç¢ºæ€§**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æŠ€è¡“èƒŒæ™¯ã‚’ç†è§£
- âœ… **é©åˆ‡ãªç²’åº¦**: å¤‰æ›´è¦æ¨¡ã«å¿œã˜ãŸè©³ç´°ãƒ¬ãƒ™ãƒ«
- âœ… **å®Ÿç”¨æ€§**: å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ´»ç”¨ã§ãã‚‹å†…å®¹

### æŠ€è¡“ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: å¿œç”¨æƒ…å ±æŠ€è¡“è€…è©¦é¨“ å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: Node.js 22, TypeScript, Hono.js, Prisma, PostgreSQL
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **é–‹ç™ºæ‰‹æ³•**: TDD (Test-Driven Development)

## ðŸ“Š åˆ†æžå¯¾è±¡ãƒ‡ãƒ¼ã‚¿
\`\`\`json
$(cat /tmp/pr-analysis.json)
\`\`\`

## ðŸŽ¨ å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

### 1. PRã‚¿ã‚¤ãƒˆãƒ«
\`\`\`
æ—¥æœ¬èªžã‚¿ã‚¤ãƒˆãƒ«ä¾‹: "å­¦ç¿’åŠ¹çŽ‡åˆ†æžæ©Ÿèƒ½ã®æ‹¡å……"  
è‹±èªžã‚³ãƒŸãƒƒãƒˆä¾‹: "feat(analysis): enhance learning efficiency analysis features"
\`\`\`

### 2. PRèª¬æ˜Žæ–‡ (markdown)
\`\`\`markdown
## Summary
[å¤‰æ›´æ¦‚è¦ã‚’3-5è¡Œã§è¦ç´„]

## ðŸ”§ å®Ÿè£…å†…å®¹
### ä¸»ãªå¤‰æ›´ç‚¹
- [å¤‰æ›´ç‚¹1: å…·ä½“çš„ãªæ©Ÿèƒ½è¿½åŠ ]
- [å¤‰æ›´ç‚¹2: æŠ€è¡“çš„æ”¹å–„]
- [å¤‰æ›´ç‚¹3: ãã®ä»–ã®å¤‰æ›´]

### æŠ€è¡“çš„è©³ç´°  
- [å®Ÿè£…æ–¹æ³•ã‚„æŠ€è¡“é¸æŠžã®ç†ç”±]
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ç‚¹]

## ðŸ“‹ å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ
[ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»Lintçµæžœã®çµ±åˆã¨è§£é‡ˆ]

## ðŸ§ª Test plan
- [ ] [ãƒ†ã‚¹ãƒˆé …ç›®1]
- [ ] [ãƒ†ã‚¹ãƒˆé …ç›®2]

## ðŸ” Review focus
### å„ªå…ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
1. **[æŠ€è¡“é ˜åŸŸ1]**: [å…·ä½“çš„ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ]
2. **[æŠ€è¡“é ˜åŸŸ2]**: [å…·ä½“çš„ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ]

### æ³¨æ„äº‹é …
- [ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®æ³¨æ„ç‚¹]

## Breaking changes
[ç ´å£Šçš„å¤‰æ›´ã®æœ‰ç„¡ã¨å½±éŸ¿]
\`\`\`

## ðŸš€ ç”ŸæˆæŒ‡ç¤º
ä¸Šè¨˜ã®åˆ†æžãƒ‡ãƒ¼ã‚¿ã¨ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã«åŸºã¥ã„ã¦ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã§ãã‚‹é«˜å“è³ªãªPRæ–‡æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å¤‰æ›´å†…å®¹ã®æ„å›³ã‚’ç†è§£ã—ã€æŠ€è¡“çš„èƒŒæ™¯ã‚’è€ƒæ…®ã—ãŸè‡ªç„¶ã§èª¬å¾—åŠ›ã®ã‚ã‚‹æ–‡æ›¸ä½œæˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

---
**é‡è¦**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆçš„ãªè¡¨ç¾ã§ã¯ãªãã€ã“ã®ç‰¹å®šã®å¤‰æ›´ã«å¯¾ã™ã‚‹å…·ä½“çš„ã§å®Ÿç”¨çš„ãªå†…å®¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
EOF

log_success "Claude Codeè§£æžã‚¬ã‚¤ãƒ€ãƒ³ã‚¹æº–å‚™å®Œäº†"

# 4. å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç†
case "$OUTPUT_MODE" in
    "interactive")
        log_info "ðŸ”„ å¯¾è©±çš„ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
        echo ""
        echo "=============================================="
        echo "ðŸ¤– Claude Code PRç”Ÿæˆ - å¯¾è©±çš„ãƒ¢ãƒ¼ãƒ‰"
        echo "=============================================="
        echo ""
        echo "ðŸ“ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™ã•ã‚Œã¾ã—ãŸ:"
        echo "  - åˆ†æžãƒ‡ãƒ¼ã‚¿: /tmp/pr-analysis.json"
        echo "  - è§£æžã‚¬ã‚¤ãƒ‰: /tmp/claude-pr-prompt.md"
        echo ""
        echo "ðŸ‘¨â€ðŸ’» æ¬¡ã®æ‰‹é †ã§PRã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:"
        echo ""
        echo "1. ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§Claude Codeã«è§£æžã‚¬ã‚¤ãƒ‰ã‚’æä¾›:"
        echo "   Claude Code: /tmp/claude-pr-prompt.md ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo ""
        echo "2. Claude CodeãŒPRæ–‡æ›¸ã‚’ç”Ÿæˆ"
        echo ""  
        echo "3. ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦èª¿æ•´"
        echo ""
        echo "4. PRã‚’ä½œæˆ:"
        echo "   gh pr create --title \"[ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«]\" --body \"[ç”Ÿæˆã•ã‚ŒãŸèª¬æ˜Žæ–‡]\""
        echo ""
        ;;
        
    "dry-run")
        log_info "ðŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
        echo ""
        echo "=============================================="
        echo "ðŸ“‹ PRç”Ÿæˆäºˆå®šå†…å®¹ (ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³)"
        echo "=============================================="
        echo ""
        echo "ðŸ“Š åŽé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:"
        branch=$(cat /tmp/pr-analysis.json | grep -o '"branch": "[^"]*"' | cut -d'"' -f4)
        files_count=$(cat /tmp/pr-analysis.json | grep -o '"changed_files_count": [0-9]*' | grep -o '[0-9]*')
        total_additions=$(cat /tmp/pr-analysis.json | grep -o '"total_additions": [0-9]*' | grep -o '[0-9]*')
        
        echo "  - ãƒ–ãƒ©ãƒ³ãƒ: $branch"
        echo "  - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $files_count"
        echo "  - è¿½åŠ è¡Œæ•°: $total_additions"
        echo ""
        echo "ðŸ“ Claude Codeè§£æžç”¨ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†:"
        echo "  - /tmp/pr-analysis.json ($(wc -l < /tmp/pr-analysis.json)è¡Œ)"
        echo "  - /tmp/claude-pr-prompt.md ($(wc -l < /tmp/claude-pr-prompt.md)è¡Œ)"
        echo ""
        echo "âš¡ å®Ÿéš›ã®å®Ÿè¡Œã«ã¯ '--mode interactive' ã¾ãŸã¯ '--mode auto' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
        ;;
        
    "auto")
        log_warning "ðŸš§ è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã¯é–‹ç™ºä¸­ã§ã™"
        echo "ç¾åœ¨ã¯å¯¾è©±çš„ãƒ¢ãƒ¼ãƒ‰ (interactive) ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™"
        echo "å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§Claude APIé€£æºã«ã‚ˆã‚‹å®Œå…¨è‡ªå‹•åŒ–ã‚’äºˆå®š"
        ;;
        
    *)
        log_error "ç„¡åŠ¹ãªãƒ¢ãƒ¼ãƒ‰: $OUTPUT_MODE"
        echo "ä½¿ç”¨å¯èƒ½ãªãƒ¢ãƒ¼ãƒ‰: interactive, auto, dry-run"
        exit 1
        ;;
esac

# 5. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—è¨­å®š
if [ "$OUTPUT_MODE" != "interactive" ]; then
    log_info "ðŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™"
    echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹ã«ã¯ Ctrl+C ã§ä¸­æ–­ã—ã¦ãã ã•ã„..."
    sleep 3
    rm -f /tmp/pr-analysis.json /tmp/claude-pr-prompt.md
    log_success "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
else
    log_info "ðŸ’¾ Claude Codeä½œæ¥­ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã—ã¦ã„ã¾ã™:"
    echo "  - /tmp/pr-analysis.json"
    echo "  - /tmp/claude-pr-prompt.md"
    echo ""
    echo "ä½œæ¥­å®Œäº†å¾Œã¯æ‰‹å‹•ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„"
fi

log_success "ðŸŽ‰ Claudeä¸»å°ŽPRç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ å‡¦ç†å®Œäº†"